<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Legal Document Search</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    /* suggestions dropdown sits under the input */
    #suggestions { z-index: 1050; max-height: 320px; overflow:auto; }
    #suggestions .list-group-item { cursor: pointer; }
    mark { padding: 0 .1rem; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h1 class="mb-4">Legal Document Search</h1>

    <div class="card p-3 shadow-sm">
      <div class="mb-3 position-relative">
        <label class="form-label">Enter your query</label>
        <input id="q" class="form-control" placeholder="type your text here"/>
        <!-- realtime suggestions -->
        <div id="suggestions" class="list-group position-absolute w-100 shadow-sm d-none"></div>
      </div>
      
    </div>

    
  </div>

<script>
  // ---------- helpers ----------
  const DEBOUNCE_MS = 200;

  function debounce(fn, ms) { // waits until user stops typing ~ms
    let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); };
  }
  function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
  function highlight(text, query){
    if(!query) return escapeHTML(text);
    const escQ = query.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    const re = new RegExp("(" + escQ + ")", "ig");
    return escapeHTML(text).replace(re, "<mark>$1</mark>");
  }
  function hideSuggestions(){
    const box = document.getElementById("suggestions");
    box.classList.add("d-none");
    box.innerHTML = "";
  }

  // ---------- realtime suggestions ----------
  async function fetchSuggestions(q){
    if(q.length < 2){ hideSuggestions(); return; }
    try{
      const r = await fetch("/suggest?" + new URLSearchParams({ q, k: 8 }));
      const data = await r.json();
      renderSuggestions(q, data.suggestions || []);
    }catch(e){ hideSuggestions(); }
  }
  const debouncedSuggest = debounce(fetchSuggestions, DEBOUNCE_MS);

  function renderSuggestions(q, items){
    // dropdown under the input showing best-matching snippets
    const box = document.getElementById("suggestions");
    if(!items.length){ hideSuggestions(); return; }
    box.innerHTML = items.map(s => `
      <a href="#" class="list-group-item list-group-item-action"
         data-text="${encodeURIComponent(s.text)}"
         data-title="${encodeURIComponent(s.title)}"
         data-url="${s.url || ""}">
        <div class="fw-semibold">${escapeHTML(s.title || "")}</div>
        <!-- Clicking this sentence will copy into the input -->
        <div class="small text-muted use-sentence">${highlight(s.text || "", q)}</div>
        ${s.url ? `
          <button type="button"
                  class="btn btn-sm btn-outline-secondary mt-2 open-pdf"
                  onclick="event.preventDefault(); event.stopPropagation(); window.open('${s.url}','_blank')">
            Open PDF
          </button>` : ""}
      </a>
    `).join("");
    box.classList.remove("d-none");
  }

  // ---------- EVENTS ----------
  // Click a suggestion's sentence -> fill input only (no search)
  document.getElementById("suggestions").addEventListener("click", (e)=>{
    if (e.target.closest(".open-pdf")) return;   // 
    const sentenceEl = e.target.closest(".use-sentence");
    if (!sentenceEl) return;

    const item = e.target.closest(".list-group-item");
    if(!item) return;
    e.preventDefault();

    const sentence = decodeURIComponent(item.dataset.text || "");
    document.getElementById("q").value = sentence;
    hideSuggestions(); // 
  });

  // hide suggestions when clicking outside
  document.addEventListener("click", (e)=>{
    const q = document.getElementById("q");
    const box = document.getElementById("suggestions");
    if (e.target !== q && !box.contains(e.target)) hideSuggestions();
  });

  // wire up type-ahead only
  const qInput = document.getElementById("q");
  qInput.addEventListener("input", e => debouncedSuggest(e.target.value));
  // No Enter-to-search, no Search button
</script>
</body>
</html>

